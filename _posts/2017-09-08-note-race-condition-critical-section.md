---
layout: post
title: "Javaå¹¶å‘ç¬”è®°ä¹‹ Race Condition and Critical Section"
date: 2017-09-08
tags:
    - java    
    - å¹¶å‘
keywords: java
description: Javaå¹¶å‘ç¬”è®°ä¹‹ Race Condition and Critical Section
---
### å‰è¨€
è¿™å‡ å¤©å­¦ä¹ å¹¶å‘ç¼–ç¨‹,[race-conditions-and-critical-sections](http://tutorials.jenkov.com/java-concurrency/race-conditions-and-critical-sections.html),ç¿»è¯‘ä¸€ä¸‹ï¼Œå†™ç‚¹è‡ªå·±çš„ç¬”è®°å¹¶åŠ ä¸Šç‚¹ä¸ªäººçš„ç†è§£ã€‚

ç½‘é¡µä¸­é‡Œä¸­æåˆ°ä¸¤ä¸ªåè¯Race Condition å’Œ Critical Sectionï¼Œæ¥ä¸‹æ¥å¯¹ä»–ä»¬è¿›è¡Œè§£é‡Šå’Œä¾‹å­æ¼”ç¤ºã€‚

### Race Condition

åœ¨å¤šçº¿ç¨‹åœºæ™¯ä¸‹ï¼Œå½“å¤šä¸ªçº¿ç¨‹è®¿é—®åŒä¸€å—èµ„æºï¼Œä¸”æ‰§è¡Œç»“æœä¸çº¿ç¨‹è®¿é—®çš„å…ˆåé¡ºåºç›¸å…³ï¼Œå³è¡¨æ˜è¿™é‡Œé¢å­˜åœ¨ç€Race Conditionï¼Œä¸­æ–‡ç¿»è¯‘å³ç«äº‰æ¡ä»¶ã€‚

çœ‹ä¸‹é¢ğŸ‘‡çš„ä»£ç ,å¤šä¸ªçº¿ç¨‹éƒ½ä¼šè°ƒç”¨addæ–¹æ³•å¯¹åŒä¸€ä¸ªcountå€¼è¿›è¡ŒåŠ æ³•ã€‚

```
  public class Counter {

     protected long count = 0;

     public void add(long value){
         this.count = this.count + value;
     }
  }
```

ç„¶è€Œ,addæ–¹æ³•ä¸­çš„åŠ æ³•éœ€è¦å¥½å‡ ä¸ªæ­¥éª¤æ‰èƒ½å®Œæˆã€‚


```
1. ä»å†…å­˜ä¸­è¯»å–countçš„å€¼åˆ°å¯„å­˜å™¨ã€‚
2. åŠ valueã€‚
3. å†™å›å†…å­˜ã€‚
```

å¦‚æœæœ‰ä¸¤ä¸ªçº¿ç¨‹éƒ½å¯¹addæ–¹æ³•è¿›è¡Œäº†æ“ä½œï¼Œæ¯”å¦‚çº¿ç¨‹AåŠ 3,çº¿ç¨‹BåŠ 2,æˆ‘ä»¬çš„é¢„æœŸç»“æœæ˜¯5ã€‚ç”±äºçº¿ç¨‹çš„è®¿é—®é¡ºåºä»¥åŠåˆ‡æ¢çš„æ—¶é—´æ˜¯ä¸å¯é¢„æœŸçš„,åœ¨ç‰¹å®šçš„è®¿é—®é¡ºåºä¸‹ï¼Œå¯èƒ½å‡ºç°ä¸€äº›å‡ºä¹æ„æ–™çš„ç»“æœ,æ¯”å¦‚ä¸‹æ–‡ä¸­çš„æ‰§è¡Œé¡ºåºã€‚

```
A:  Reads this.count into a register (0)
B:  Reads this.count into a register (0)
B:  Adds value 2 to register
B:  Writes register value (2) back to memory. this.count now equals 2
A:  Adds value 3 to register
A:  Writes register value (3) back to memory. this.count now equals 3

```

ç”±äºåŠ æ³•ä¸æ˜¯åŸå­æ€§çš„ï¼Œåœ¨åŠ æ³•æ‰§è¡Œè¿‡ç¨‹ä¸­çš„æ¯ä¸€æ­¥éƒ½å¯èƒ½å­˜åœ¨ç€çº¿ç¨‹åˆ‡æ¢ã€‚
æ¯”å¦‚çº¿ç¨‹Aå’ŒBéƒ½å…ˆåè¯»åˆ°0,ç„¶åçº¿ç¨‹Bå ç”¨äº†æ—¶é—´ç‰‡å®Œæˆäº†åŠ 2çš„æ“ä½œ,å†™å›äº†å†…å­˜ï¼Œæ­¤æ—¶å†…å­˜ä¸­countçš„å€¼ç­‰äº2ã€‚
ç„¶åçº¿ç¨‹Aé‡æ–°å¾—åˆ°è°ƒåº¦ï¼Œæ­¤æ—¶çº¿ç¨‹Aå†…éƒ¨çš„countå€¼è¿˜æ˜¯0,çº¿ç¨‹Aå¯¹ä¸»å†…å­˜å†…countçš„å˜åŒ–æ˜¯ä¸å¯è§çš„,ç„¶åçº¿ç¨‹å®ŒæˆåŠ 3æ“ä½œï¼Œå†™å›å†…å­˜ï¼Œæ­¤æ—¶countå€¼ç­‰äº3ã€‚

ä¸Šè¿°ä»£ç ä¸­çš„addæ–¹æ³•å†…éƒ¨å°±å­˜åœ¨ç€ç«äº‰æ¡ä»¶ï¼Œä¼šæ ¹æ®çº¿ç¨‹æ‰§è¡Œé¡ºåºçš„ä¸ç¡®å®šæ€§å½±å“æœ€åçš„æ‰§è¡Œç»“æœã€‚

### Critical Section

æˆ‘ä»¬æŠŠä¼šå¯¼è‡´Race Conditionçš„åŒºåŸŸç§°ä¸ºCritical Section,ä¸­æ–‡ç¿»è¯‘ä¸´ç•ŒåŒºã€‚ä¸´ç•ŒåŒºå³æ¯ä¸ªçº¿ç¨‹ä¸­è®¿é—®ä¸´ç•Œèµ„æºçš„é‚£æ®µä»£ç ã€‚

åœ¨ä¸Šæ–‡çš„ä»£ç ä¸­,this.countå°±æ˜¯ä¸´ç•Œèµ„æº

```
this.count = this.count + value
```

å°±æ˜¯ä¸´ç•ŒåŒº,ä¸ºäº†ä¿è¯æ‰§è¡Œç»“æœçš„æ­£ç¡®æ€§,é¿å…ä¸´ç•ŒåŒºå†…äº§ç”Ÿç«äº‰æ¡ä»¶,æˆ‘ä»¬éœ€è¦ç¡®ä¿ä¸´ç•ŒåŒºå†…çš„æ‰§è¡Œæ˜¯åŸå­çš„,æ¯æ¬¡ä»…å…è®¸ä¸€ä¸ªçº¿ç¨‹è¿›å»,è¿›å…¥åä¸å…è®¸å…¶ä»–çº¿ç¨‹è¿›å…¥ã€‚

æˆ‘ä»¬å¯ä»¥é‡‡ç”¨çº¿ç¨‹åŒæ­¥åšåˆ°ä»¥ä¸Šçš„è¦æ±‚ï¼Œçº¿ç¨‹åŒæ­¥å¯ä»¥ä½¿ç”¨synchronizedåŒæ­¥ä»£ç ,æˆ–è€…locks,æˆ–è€…æ˜¯åŸå­å˜é‡æ¯”å¦‚AtomicIntegerç­‰ã€‚

å¯ä»¥æŠŠæ•´ä¸ªä¸´ç•ŒåŒºä½¿ç”¨synchronizedåŒæ­¥ï¼Œä½†æŠŠä¸´ç•ŒåŒºæ‹†åˆ†æˆå¤šä¸ªå°çš„ä¸´ç•ŒåŒºèƒ½å¤Ÿé™ä½å¯¹å…±äº«èµ„æºçš„äº‰å¤ºï¼Œå¢åŠ æ•´ä¸ªä¸´ç•ŒåŒºçš„ååé‡,ä¸‹é¢ä¸¾ä¸ªä¾‹å­ã€‚


```java
public class TwoSums {
    
    private int sum1 = 0;
    private int sum2 = 0;
    
    public void add(int val1, int val2){
        synchronized(this){
            this.sum1 += val1;   
            this.sum2 += val2;
        }
    }
}
```

åœ¨ä¸Šè¿°ä»£ç ä¸­,ç®€å•çš„åšæ³•å°±æ˜¯é”ä½æ•´ä¸ªå¯¹è±¡,åªæœ‰ä¸€ä¸ªçº¿ç¨‹èƒ½å¤Ÿæ‰§è¡Œä¸¤ä¸ªä¸åŒå˜é‡çš„åŠ æ³•æ“ä½œã€‚ç„¶è€Œï¼Œç”±äºè¿™ä¸¤ä¸ªå˜é‡æ˜¯äº’ç›¸ç‹¬ç«‹çš„ï¼Œå¯ä»¥æ‹†åˆ†åˆ°ä¸¤ä¸ªä¸åŒçš„synchronizedå—ä¸­ã€‚


```java
public class TwoSums {
    
    private int sum1 = 0;
    private int sum2 = 0;

    private Integer sum1Lock = new Integer(1);
    private Integer sum2Lock = new Integer(2);

    public void add(int val1, int val2){
        synchronized(this.sum1Lock){
            this.sum1 += val1;   
        }
        synchronized(this.sum2Lock){
            this.sum2 += val2;
        }
    }
}
```

æ”¹åŠ¨åï¼Œä¸¤ä¸ªçº¿ç¨‹å¯ä»¥åŒæ—¶åœ¨addæ–¹æ³•ä¸­æ“ä½œï¼Œä¸€ä¸ªçº¿ç¨‹åœ¨ç¬¬ä¸€ä¸ªsynchronizedå—ï¼Œå¦ä¸€ä¸ªçº¿ç¨‹åœ¨ç¬¬äºŒä¸ªsynchronizedå—ï¼Œä¸¤ä¸ªsynchronizedå—åŒæ­¥çš„æ˜¯ä¸åŒçš„å¯¹è±¡ï¼Œæ‰€ä»¥ä¸¤ä¸ªçº¿ç¨‹å¯ä»¥ç‹¬ç«‹æ‰§è¡Œï¼Œæ•´ä½“çº¿ç¨‹ç­‰å¾…çš„æ—¶é—´ä¼šå˜å°‘ï¼Œååé‡èƒ½å¤Ÿå¾—åˆ°æå‡ã€‚

